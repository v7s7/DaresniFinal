rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    /* ========================================
       HELPER FUNCTIONS
       ======================================== */
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isSelf(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }
    
    function isAdmin() {
      return isSignedIn() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Check if current user is the tutor for a given tutorProfileId
    function isTutorOwner(tutorProfileId) {
      return isSignedIn() && 
        exists(/databases/$(database)/documents/tutor_profiles/$(tutorProfileId)) &&
        get(/databases/$(database)/documents/tutor_profiles/$(tutorProfileId)).data.userId == request.auth.uid;
    }
    
    // Check if user is part of a session (as student OR tutor)
    function isInSession(sessionDoc) {
      return isSignedIn() && (
        sessionDoc.data.studentId == request.auth.uid ||
        isTutorOwner(sessionDoc.data.tutorId)
      );
    }

    /* ========================================
       SUBJECTS
       ======================================== */
    
    match /subjects/{id} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    /* ========================================
       USERS
       ======================================== */
    
    match /users/{uid} {
      // Allow showing tutor names/avatars etc.
      allow read: if isSignedIn();
      
      // User can create their own doc
      allow create: if isSelf(uid);
      
      // User can update their own doc (but not change role), or admin can update
      allow update: if (isSelf(uid) && request.resource.data.role == resource.data.role) || isAdmin();
      
      // Only admin can delete
      allow delete: if isAdmin();
    }

    /* ========================================
       TUTOR PROFILES
       ======================================== */
    
    match /tutor_profiles/{id} {
      // Anyone can browse tutors (for student discovery)
      allow read: if true;
      
      // Owner (tutor) can create their profile (doc id must match their userId)
      allow create: if isSignedIn()
                    && request.auth.uid == request.resource.data.userId;
      
      // Owner or admin can update
      allow update: if isAdmin() || (isSignedIn() && request.auth.uid == resource.data.userId);
      
      // Only admin can delete
      allow delete: if isAdmin();
    }

    /* ========================================
       TUTOR SUBJECTS (junction table)
       ======================================== */
    
    match /tutor_subjects/{id} {
      allow read: if true;
      
      // Extract tutorId from compound doc id (format: tutorId_subjectId)
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    /* ========================================
       TUTORING SESSIONS
       ======================================== */
    
    match /tutoring_sessions/{sid} {
      // Anyone signed in can read (needed for availability checks and conflict detection)
      allow read: if isSignedIn();
      
      // Student creates their own session
      allow create: if isSignedIn()
                    && request.auth.uid == request.resource.data.studentId;
      
      // Student, tutor (via profile check), or admin can update
      allow update: if isAdmin() || isInSession(resource);
      
      // Only admin can delete
      allow delete: if isAdmin();
    }

    /* ========================================
       REVIEWS
       ======================================== */
    
    match /reviews/{rid} {
      // Anyone can read reviews (for displaying on tutor profiles)
      allow read: if true;
      
      // Student can create review for their own sessions
      allow create: if isSignedIn()
                    && request.auth.uid == request.resource.data.studentId;
      
      // Student who wrote review or admin can update/delete
      allow update, delete: if isAdmin() ||
        (isSignedIn() && request.auth.uid == resource.data.studentId);
    }

    /* ========================================
       MESSAGES
       ======================================== */
    
    match /messages/{mid} {
      // Only sender or receiver can read
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.senderId ||
        request.auth.uid == resource.data.receiverId
      );
      
      // Only sender can create
      allow create: if isSignedIn()
                    && request.auth.uid == request.resource.data.senderId;
      
      // Participants or admin can modify/delete
      allow update, delete: if isAdmin() || (
        isSignedIn() && (
          request.auth.uid == resource.data.senderId ||
          request.auth.uid == resource.data.receiverId
        )
      );
    }

    /* ========================================
       FILE UPLOADS
       ======================================== */
    
    match /fileUploads/{fid} {
      // Only users in the session can read
      allow read: if isSignedIn(); // Simplified - adjust based on your needs
      
      // Only signed-in users can upload
      allow create: if isSignedIn()
                    && request.auth.uid == request.resource.data.uploaderId;
      
      // Uploader or admin can delete
      allow delete: if isAdmin() || 
        (isSignedIn() && request.auth.uid == resource.data.uploaderId);
    }

    /* ========================================
       NOTIFICATIONS
       ======================================== */
    
    match /notifications/{nid} {
      // Users can read their own notifications, admins can read admin notifications
      allow read: if isSignedIn() && (
        (resource.data.userId == request.auth.uid) ||
        (resource.data.audience == 'admin' && isAdmin())
      );
      
      // System creates notifications (handled server-side)
      allow create: if false; // Only server can create
      
      // Users can mark their notifications as read
      allow update: if isSignedIn() && (
        (resource.data.userId == request.auth.uid && 
         request.resource.data.keys().hasOnly(['isRead']) &&
         request.resource.data.isRead == true) ||
        isAdmin()
      );
      
      // Only admin can delete
      allow delete: if isAdmin();
    }

    /* ========================================
       FAVORITES
       ======================================== */
    
    match /favorites/{fid} {
      // Users can read their own favorites
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      
      // Users can create their own favorites
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      
      // Users can delete their own favorites
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }
  }
}
